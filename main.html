<!DOCTYPE html>
<html>

<head>

  <title> test </title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/src/mystyle.css">
</head>

<body>
  <div id="header-wrapper">
    <div id="menu_bar">
      <ul>
        <li id="menu-file">
          <u>F</u>ile
        </li>
        <li id="menu-edit">
          <u>E</u>dit
        </li>
        <li id="menu-view">
            <u>V</u>iew
          </li>
      </ul>
    </div>
    
    <div class="toolbar">

    </div>

    <!--
    <div class="file_dialog">
      개별파일 열기
      <input type="file" id="open_file" class="inputfile" />
      <label for="open_file">업로드</label>
    </div>
    <div class="file_dialog">
      디렉토리 열기
      <input id="open_directory" type="file" webkitdirectory directory />
      <label for="open_directory">업로드</label>
    </div>
  -->
  </div>
  <div id="workspace">
    <div class="panel-left-bar">
      <div class="bar-button" id='bt_save'>
        SAVE
      </div>
      <div class="bar-button" id='bt_tab'>
        TAB
      </div>
      <div class="bar-button" id='bt_highlight'>
        HIGH
      </div>
      <div class="bar-button" id='bt_html'>
        HTML
      </div>
    </div>
    <div class="panel-left">
      <div class="explorer-wrapper">
        <div class="explorer-bar"> EXPLORER</div>
        <div class="tree" id="tree_file"> </div>
      </div>

    </div>

    <div class="panel-center">
      <div class="tabs" id="tabs_code"> </div>
    </div>
    <div class="panel-bottom">
    </div>
  </div>
  <div id="contextMenu" style="display:none">
    <ul class="menu">
      <li id="cm_newfile">New File</li>
      <li id="cm_newfolder">New Folder</li>
      <li id="cm_rename" style="display:none">Rename</li>
      <li id="cm_delete" style="display:none">Delete</li>
    </ul>
  </div>
  <!--
    menu bar 항목
  -->
  <div id="menu-file-contents" class="menu_bar_box" style="display:none">
    <ul class="menu_bar_list">
      <li id="file-newfile">New File</li>
      <div class='list_divide'></div>
      <li id="file-openfile">
        <input type="file" id="open_file" class="inputfile" />
        <label for="open_file">Open File</label>
      </li>
      <li id="file-openfolder">
        <input id="open_directory" type="file" webkitdirectory directory />
        <label for="open_directory">Open Folder</label>
      </li>
      <div class='list_divide'></div>
      <li id="file-save">Save</li>
      <li id="file-saveall">Save All</li>
      <div class='list_divide'></div>
      <li id="file-exit">Exit</li>
    </ul>
  </div>
  <div id="menu-edit-contents" class="menu_bar_box" style="display:none">
    <ul class="menu_bar_list">
      <li id="edit-intelli">
        <div class="menu_checkbox">✓</div>
        Intellisense
      </li>
      <div class='list_divide'></div>
      <li id="edit-find">Find</li>
    </ul>
  </div>
  <div id="menu-view-contents" class="menu_bar_box" style="display:none">
      <ul class="menu_bar_list">
        <li id="view_highlight">
          <div class="menu_checkbox">✓</div>
          Highlight
        </li>
        <li id="view_option">
            Option
            <div class="menu_extend">＞</div>
          </li>
          <div class='list_divide'></div>
          <li id="view_wordwrap">
            Word Wrap
          </li>
      </ul>
    </div>
    <div id="view_option-contents" class="menu_bar_box" style="display:none">
        <ul class="menu_bar_list">
          <li id="option-a">
            a
          </li>
          <li id="option-b">
            b
          </li>
        </ul>
      </div>
  <script>
    const bt_html = document.getElementById('bt_html');
    bt_html.addEventListener('click', (event) => {
      window.open("/test.html", '_blank');
    });
  </script>

  <script type="text/javascript" src="js/intellisense.js"></script>
  <script>

    // Syntax highlight for JS
    const js = el => {
      for (const node of el.children) {
        if(node.className)
        {
          node.classList.remove('editor_node_changed');
          var map = {
            '<': '&lt',
            '>': '&gt',
          };
        
          const s = node.innerText
          .replace(/</g, '&lt').replace(/>/g, '&gt')
          .replace(/(".*?"|'.*?'|`.*?`)/g, '<strong><em>$1</em></strong>')
          //.replace(/\b(\d+)/g, '<em><strong>$1</strong></em>')
          .replace(/(\/\/.*)/g, '<span style=\"color:#6a9955\"><em>$1</em></span>')
          .replace(
            /\b(new|in|of|typeof|function|var|const|let|\.length|\.\w+)(?=[^\w])\b/g,
            '<span style=\"color:#569cd6\">$1</span>')
          .replace(
            /\b(if|else|do|while|switch|for|continue|break|return)\b/g,
            '<span style=\"color:#c586c0\">$1</span>');
            /*
          .replace(
            /&lt\/?(html|head|body|title|div|ul|li|script|span).*&gt/gi,
            '<span style=\"color:#569cd6\">$&</span>'
          )
          */
          node.innerHTML = s.split('\n').join('<br/>');
        }
      }
    };

    const editor = (el, c, highlight = js, tab = '    ') => {
      //caret 위치 관련
      const caret = () => {
        const range = window.getSelection().getRangeAt(0);
        const prefix = range.cloneRange();
        prefix.selectNodeContents(el);
        prefix.setEnd(range.endContainer, range.endOffset);
        return prefix.toString().length;
      };

      const setCaret = (pos, parent = el) => {
        for (const node of parent.childNodes) {
          if (node.nodeType == Node.TEXT_NODE) {
            if (node.length >= pos) {
              const range = document.createRange();
              const sel = window.getSelection();
              range.setStart(node, pos);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
              return -1;
            } else {
              pos = pos - node.length;
            }
          } else {
            pos = setCaret(pos, node);
            if (pos < 0) {
              return pos;
            }
          }
        }
        return pos;
      };

      //줄 추가
      const addLine = (parent = el) => {

        var div = document.createElement('div');
        div.id = 'editor_line';

        const r = window.getSelection().getRangeAt(0);
        const prefix = r.cloneRange();
        prefix.selectNodeContents(c.current_div);
        prefix.setStart(r.endContainer, r.endOffset);

        const str = prefix.toString();
        if (str != '') {
          div.innerHTML = prefix.toString();
        }
        else {
          div.innerHTML = '<br>';
        }
        if (str.length > 0) {
          prefix.deleteContents();
          prefix.insertNode(document.createElement('br'));
        }

        var temp = c.current_div.nextSibling;

        if (temp == null) {
          parent.appendChild(div);
        }
        else {
          parent.insertBefore(div, temp);
        }

        const range = document.createRange();
        range.selectNodeContents(div);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        selection.collapseToStart();
      };

      //키 입력
      var edit = true;
      var range_temp;
      var correct = false;
      el.addEventListener('keydown', e => {
        //console.log(e.which);
        getCurrentDiv();
        //editor 관련
        if (e.ctrlKey && e.which == 86)//ctrl + v
        {
          correct = true;
        }

        if (!show_intellisense) {
          c.edited = true;
          c.current_div.className = 'editor_node_changed';
          if (e.which === 8) {//backspace
            if (el.childElementCount <= 1) {
              const pos = caret();
              if (pos <= 0) {
                e.preventDefault();
              }
            }
          }
          if (e.which === 9) {//tab
            insertTab();
            e.preventDefault();
          }
          if (e.shiftKey && e.which === 219) {//{
            c.current_indent++;
          }
          if (e.shiftKey && e.which === 221) {//}
            c.current_indent--;

            const range = window.getSelection().getRangeAt(0);
            const prefix = range.cloneRange();
            prefix.selectNodeContents(el);
            prefix.setEnd(range.endContainer, range.endOffset);
            const str = prefix.toString();
            var global_indent= 0;
            global_indent += (str.match(/\{/g) || []).length;
            global_indent -= (str.match(/\}/g) || []).length;
            if (c.current_div_indent >= global_indent) {
              removeTab();
            }
          }
          if (e.which === 13) {//enter
            addLine();
            for (var i = 0; i < Math.floor(c.current_div_indent) + c.current_indent; i++) {
              insertTab();
            }
            e.preventDefault();
          }
          if (e.ctrlKey && e.which === 192) {
            intellisense.show();
            e.preventDefault();
          }
          if (e.which === 190)//.
          {
            edit = false;
          }
          if (edit == false && (event.keyCode >= 65 && event.keyCode <= 90)) {
            intellisense.show();
            edit = true;
            intellisense.temp += String.fromCharCode(e.which);
            intellisense.filter();
          }
          if (e.which === 32) { edit = false; };
          if (e.ctrlKey && e.which == 83) {
            savefile();
            e.preventDefault();
          }
          if (e.ctrlKey && e.which == 70) {
            show_finder ? finder.remove():finder.show();
            e.preventDefault();
          }
        }
        else {
          if (e.which === 38 || e.which === 40) {
            e.preventDefault();
          }
          else if (e.which === 13) {//enter
            insertIntelli();
            intellisense.remove();
            e.preventDefault();
          }
          else if (e.keyCode >= 65 && e.keyCode <= 90) {
            intellisense.temp += String.fromCharCode(e.which);
            intellisense.filter();
          }
          else if (e.which === 20 || e.which === 16) {

          }
          else {
            intellisense.remove();
          }

          if (e.which === 8) {
            intellisense.temp = intellisense.temp.slice(0, -1);
          }
        }
      });
      el.addEventListener('keyup', e => {
        if (e.keyCode == 0x20) {//e.keyCode >= 0x30 || 
          const pos = caret();
          highlight(el);
          setCaret(pos);
        }
        if (show_intellisense) {
          range_temp = window.getSelection().getRangeAt(0);
        }
        if (correct) {
          correctNode();
          correct = false;
        }

      });


      //함수 모음
      function getLine() {
        var nodes = Array.prototype.slice.call(el.children);
        //var liRef = window.getSelection().getRangeAt(0).commonAncestorContainer.parentNode;
        var num = nodes.indexOf(c.current_div);
        if (num !== -1) {
          c.current_line = num + 1;
        }
      }
      function getCurrentDiv() {
        const range = window.getSelection().getRangeAt(0);
        var div = range.commonAncestorContainer;
        while (div.id != 'editor_line') {
          div = div.parentNode;
        }
        c.current_div = div;
        //탭 개수 구하기
        const prefix = range.cloneRange();
        prefix.selectNodeContents(div);
        prefix.setEnd(range.endContainer, range.endOffset);
        const str = prefix.toString();
        var count = 0;
        for (var i = 0; i < str.length; i++) {
          if (str.charAt(i) != ' ') {
            break;
          }
          count++;
        }

        c.current_indent = 0;
        c.current_indent += (str.match(/\{/g) || []).length;
        c.current_indent -= (str.match(/\}/g) || []).length;
        c.current_div_indent = count / 4;
      }
      function insertTab() {
        const pos = caret() + tab.length;
        const range = window.getSelection().getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(tab));
        setCaret(pos);
      }
      function removeTab() {
        const range = window.getSelection().getRangeAt(0);
        const prefix = range.cloneRange();
        prefix.selectNodeContents(c.current_div);
        prefix.setStart(range.endContainer,0);
        prefix.setEnd(range.endContainer, 4);
        prefix.deleteContents(); 
      }
      function insertIntelli() {
        var str = intellisense.liSelected.innerHTML;
        str = str.slice(intellisense.temp.length);

        const range = range_temp;
        const prefix = range.cloneRange();
        prefix.selectNodeContents(el);
        prefix.setEnd(range.endContainer, range.endOffset);

        var pos = prefix.toString().length + str.length;
        if (str.slice(-1) == ')') { pos--; }
        range.deleteContents();
        range.insertNode(document.createTextNode(str));
        highlight(el);
        setCaret(pos);
      }

      function correctNode() {
        for (const node of el.childNodes) {
          for (var i = 0; i < node.childNodes.length;)// children of node.childNodes)
          {
            if (node.childNodes[i].id == 'editor_line') {
              el.insertBefore(node.childNodes[i], node);
            } else {
              i++;
            }
          }
        }
        for (const node of el.childNodes) {
          if (!node.innerHTML) {
            node.remove();
          }
        }
      }


      function savefile() {
        var text = '';
        for (const node of el.children) {
          text += node.innerHTML
            .replace(/\<\/?br\>/g, '')
            .replace(/\<\/?strong\>/g, '')
            .replace(/\<\/?em\>/g, '')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>');
          text += '\n';
        }

        var textFile = null;
        var data = new Blob([text], { type: 'text/plain' });

        if (textFile !== null) {
          window.URL.revokeObjectURL(textFile);
        }

        textFile = window.URL.createObjectURL(data);
        var link = document.createElement("a");
        link.href = textFile;
        link.download = c.file_name;
        link.click();
      }

      const bt_save = document.getElementById('bt_save');
      bt_save.addEventListener('click', (event) => {
        if (c.tab_id == c.current_tab) {
          savefile();
        }

      });

      el.addEventListener('trigger', (event) => {
        save();
      });

      function save() {
        var text = '';
        for (const node of el.children) {
          text += node.innerHTML
            .replace(/\<\/?br\>/g, '')
            .replace(/\<\/?strong\>/g, '')
            .replace(/\<\/?em\>/g, '')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>');
          text += '\n';
        }
        c.data = text;
        c.edited = false;
      }

      //변경 이벤트
      MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
      var observer = new MutationObserver(function (mutations, observer) {
        //console.log(mutations, observer);
        getLine();
      });

      // define what element should be observed by the observer
      // and what types of mutations trigger the callback
      observer.observe(document, {
        subtree: true, characterData: false, childList: true, attributes: true
      });

      //find 구현
      show_finder = false;
      const finder = {
        search_result : [],
        extended : false,
        show: function() {
          const view = document.createElement('div');
          view.id = 'finder-wrapper';
          view.style.height = '30px';
          
          const findtext = document.createElement('input');
          findtext.id = 'finder-text';
          findtext.type = 'text';
          view.appendChild(findtext);

          findtext.addEventListener('keydown', (e) => {
            if(e.which == 13)
            {
              this.search();
            }
          });

          const label = document.createElement('div');
          label.id = 'result_label';
          view.appendChild(label);

          const replacetext = document.createElement('input');
          replacetext.id = 'replace-text';
          replacetext.type = 'text';
          replacetext.style.display = 'none';
          view.appendChild(replacetext);

          const previous = document.createElement('div');
          previous.id = 'finder_previous';
          previous.style.right = '60px';
          previous.style.top = '5px';
          previous.innerText = '↑';
          previous.classList.add('finder-button');
          view.appendChild(previous);

          const next = document.createElement('div');
          next.id = 'finder_next';
          next.style.right = '40px';
          next.style.top = '5px';
          next.innerText = '↓';
          next.classList.add('finder-button');
          view.appendChild(next);

          const close = document.createElement('div');
          close.id = 'finder_close';
          close.style.right = '5px';
          close.style.top = '5px';
          close.innerText = 'X';
          close.classList.add('finder-button');
          view.appendChild(close);

          close.addEventListener('click', (e) => {
            show_finder = false;
            this.remove();
          });

          const change = document.createElement('div');
          change.id = 'finder_change';
          change.style.right = '140px';
          change.style.bottom = '5px';
          change.innerText = '↔';
          change.classList.add('finder-button');
          change.style.display = 'none';
          view.appendChild(change);

          const changeall = document.createElement('div');
          changeall.id = 'finder_changeall';
          changeall.style.right = '120px';
          changeall.style.bottom = '5px';
          changeall.innerText = '⇔';
          changeall.classList.add('finder-button');
          changeall.style.display = 'none';
          view.appendChild(changeall);

          const toggle = document.createElement('div');
          toggle.id = 'finder-toggle';
          toggle.style.lineHeight = '30px';
          toggle.innerText = '＞';
          toggle.addEventListener('click', (e) => {
            if(this.extended)
            {
              view.style.height = '30px';
              toggle.style.lineHeight = '30px';
              toggle.innerText = '＞';
              replacetext.style.display = 'none';
              change.style.display = 'none';
              changeall.style.display = 'none';
              this.extended=false;
            }
            else
            {
              view.style.height = '60px';
              toggle.style.lineHeight = '60px';
              toggle.innerText = '∨';
              replacetext.style.display = 'block';
              change.style.display = 'block';
              changeall.style.display = 'block';
              this.extended=true;
            }
          });
          view.appendChild(toggle);

          show_finder = true;
          document.body.appendChild(view);
        },
        remove: function () {
          if (document.getElementById('finder-wrapper')) {
            document.getElementById('finder-wrapper').remove();
            var nodes = document.getElementsByClassName('highlight_find');
            for(var i = 0; i < nodes.length;)
            {
              var temp = nodes[i].innerText;
              nodes[i].parentElement.insertBefore(document.createTextNode(temp), nodes[i]);
              nodes[i].remove();
            }
          }
          show_finder = false;
        },
        search: function () {
          var map = {
            '<': '&lt',
            '>': '&gt',
          };

          this.search_result = [];
          var nodes = document.getElementsByClassName('highlight_find');
          for(var i = 0; i < nodes.length;)
          {
            var temp = nodes[i].innerText;
            nodes[i].parentElement.insertBefore(document.createTextNode(temp), nodes[i]);
            nodes[i].remove();
          }

          var target = document.getElementById('finder-text').value;
          var c = el.children;
          var regex = /(<([^>]+)>)/ig;
          for (var i = 0; i < c.length; i++) {
  
            var temp = c[i].innerHTML.replace(regex, '');
            var index = temp.indexOf(target,0);
            if(index >= 0)
            {
              c[i].innerHTML = temp;
              c[i].className = 'editor_node_changed';
            }
            while(index >= 0)
            {
              this.search_result.push(i + '/' + index);
              index = temp.indexOf(target, index+1);
            }
            
          }
          var offset = 0;
          var n = 0;
          for(var i = 0; i < this.search_result.length; i++)
          {
            var l = this.search_result[i].split('/');
            if(n != parseInt(l[0])){
              n = parseInt(l[0]);
              offset = 0;
            }
            var t = c[l[0]].innerHTML.slice(0, parseInt(l[1]) + offset) + '<span class=\"highlight_find\" style=\"background-color:#c57a2b\">' + target + '</span>' + c[l[0]].innerHTML.slice(parseInt(l[1])+ target.length + offset);
            c[l[0]].innerHTML = t;
            offset += 69;
          }

        /*
          const s = node.innerText
          .replace(/</g, '&lt').replace(/>/g, '&gt')
          .replace(/(".*?"|'.*?'|`.*?`)/g, '<strong><em>$1</em></strong>')
          //.replace(/\b(\d+)/g, '<em><strong>$1</strong></em>')
          .replace(/(\/\/.*)/g, '<span style=\"color:#6a9955\"><em>$1</em></span>')
          .replace(
            /\b(new|in|of|typeof|function|var|const|let|\.length|\.\w+)(?=[^\w])\b/g,
            '<span style=\"color:#569cd6\">$1</span>');
          c[i].innerHTML = s.split('\n').join('<br/>');
          */
          document.getElementById('result_label').innerText = this.search_result.length;
        }
      }

      //intellisense 구현
      show_intellisense = false;
      const intellisense = {
        liSelected: null,
        temp: '',
        list: [],
        view: null,
        listbox: null,
        show: function () {
          this.temp = '';
          this.list = [];
          const range = window.getSelection().getRangeAt(0);
          range.deleteContents();
          const span = document.createElement('span');
          range.insertNode(span);
          const temp = span.getBoundingClientRect();
          var x = temp.left;
          var y = temp.bottom;
          span.remove();

          const view = document.createElement('div');
          view.id = 'intellisense';
          view.style.left = x + 'px';
          view.style.top = y + 'px';
          this.view = view;

          const listbox = document.createElement('div');
          listbox.id = "listbox";
          this.listbox = listbox;

          this.import_list();

          this.list_update();

          view.appendChild(listbox);
          document.body.appendChild(view);
          show_intellisense = true;
        },
        import_list: function () {
          for (var i = 0; i < _javascript.keywords.length; i++) {
            this.list.push(_javascript.keywords[i]);
          }

          for (var i = 0; i < _javascript.object.length; i++) {
            const methods = _javascript[_javascript.object[i]].methods;
            for (var j = 0; j < methods.length; j++) {
              this.list.push(methods[j]);
            }
            const properties = _javascript[_javascript.object[i]].properties;
            for (var j = 0; j < properties.length; j++) {
              this.list.push(properties[j]);
            }
            const child = _javascript[_javascript.object[i]].child;
            if (child) {
              for (var j = 0; j < child.length; j++) {
                this.list.push(child[j]);
              }
            }
          }

        },
        filter: function () {
          const regex = new RegExp('^' + this.temp, 'gi');
          const temp_list = []
          for (var i = 0; i < this.list.length; i++) {
            if (this.list[i].match(regex)) {
              temp_list.push(this.list[i]);
            }
          }
          this.list = temp_list;
          this.list_update();
        },
        list_update: function () {
          while (this.listbox.hasChildNodes()) { this.listbox.removeChild(this.listbox.firstChild); }

          const ul = document.createElement('ul');
          ul.classList.add('list');

          const li_list = [];

          if (this.list.length > 0) {
            var index = 0;
            //목록 리스트 생성
            for (var i = 0; i < this.list.length; i++) {
              const li = document.createElement('li');
              li.innerHTML = this.list[i];
              li.id = i;
              ul.appendChild(li);
              li_list.push(li);
              li.addEventListener('click', e => {
                this.liSelected.classList.remove('list_selected');
                index = li.id;
                this.liSelected = li_list[index]
                this.liSelected.classList.add('list_selected');
                insertIntelli();
                intellisense.remove();
              });
            }

            //방향키 사용
            li_list[0].classList.add('list_selected')
            this.liSelected = li_list[0];
            el.addEventListener('keydown', e => {
              if (show_intellisense) {
                if (e.which === 40)//down
                {
                  this.liSelected.classList.remove('list_selected');
                  index++;
                  if (index < li_list.length) {
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  } else {
                    index = li_list.length - 1;
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  }
                  this.view.scrollTop = (this.liSelected.offsetTop - 50);
                  e.preventDefault();
                }
                else if (e.which === 38)//up
                {
                  this.liSelected.classList.remove('list_selected');
                  index--;
                  if (index > 0) {
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  } else {
                    index = 0;
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  }
                  this.view.scrollTop = (this.liSelected.offsetTop - 50);
                  e.preventDefault();
                }
              }
            });
          }
          else {
            this.remove();
          }
          this.listbox.appendChild(ul);
        },
        remove: function () {
          if (document.getElementById('intellisense')) {
            document.getElementById('intellisense').remove();
          }
          show_intellisense = false;
        }
      };
    };
  </script>
  <script>

    class Tab {
      element;
      ul;
      contents;
      tab_context = [];
      previous = 0;
      current_tab = 0;
      count = 0;
      constructor(id) {
        this.element = document.getElementById(id);
        var ul = document.createElement('ul');
        var div = document.createElement('div');
        div.classList.add('tab-wrapper');
        this.element.appendChild(ul);
        this.element.appendChild(div);

        this.ul = this.element.querySelector('ul');
        this.contents = this.element.querySelector('div');
      }
      focus(index) {
        if (this.count > 0) {
          var li = this.ul.querySelectorAll('li');
          var con = this.contents.querySelectorAll("div[class='tab_content'");
          if (this.previous > 0 && this.previous <= this.count) {
            li[this.previous - 1].classList.remove('tab_current');
            con[this.previous - 1].style.display = 'none';
          }
          li[index - 1].classList.add('tab_current');
          con[index - 1].style.display = 'block';
          this.previous = index;
          this.current_tab = index;
          for (var c of this.tab_context) {
            c.current_tab = this.current_tab;
          }
        }
      }

      update() {
        var li = this.ul.querySelectorAll('li');
        var con = this.contents.querySelectorAll("div[class='tab_content'");
        for (var i = 0; i < li.length; i++) {
          li[i].id = i + 1;
        }
        for (var i = 0; i < con.length; i++) {
          con[i].id = i + 1;
        }
        for (var i = 0; i < li.length; i++) {
          this.tab_context[i].tab_id = i + 1;
        }
      }
      closeTab(index) {
        this.count--;
        var li = this.ul.querySelectorAll('li');
        var con = this.contents.querySelectorAll("div[class='tab_content'");
        if (index <= this.previous) {
          this.previous--;
        }
        if (this.previous < 1)
          this.previous = 1;
        li[index - 1].remove();
        con[index - 1].remove();
        this.tab_context.splice(index - 1, 1);
        this.update();
        this.focus(this.previous);
      }

      addTab(context) {
        for (var c of this.tab_context) {
          if (c.path == context.path) {
            this.focus(c.tab_id);
            return;
          }
        }

        this.count++;

        const ev = new CustomEvent('trigger', {
          bubbles: false,
          detail: null
        });

        var tab = document.createElement('li')
        tab.classList.add('tab');
        tab.id = this.count;
        var text = document.createElement('div');
        text.id = 'tab_text';
        text.innerText = context.file_name;
        tab.appendChild(text);
        tab.addEventListener('click', (event) => {
          if (event.target.id != '' && event.target.id != 'tab_text') {
            this.focus(event.target.id);
          }
          if (event.target.id == 'tab_text')
          {
            if(event.target.parentElement.id != '')
            {
              this.focus(event.target.parentElement.id);
            }
          }
        });
        var tab_close = document.createElement('div');
        tab_close.classList.add('tab_close');
        tab_close.innerHTML = '×';
        tab_close.addEventListener('click', (event) => {
          if (context.edited == true) {
            if (confirm("Save File '" + context.file_name + "'?") == true) {
              code_editor.dispatchEvent(ev);
            }
          }
          this.closeTab(event.target.parentElement.id);
        });
        tab.appendChild(tab_close);
        this.ul.appendChild(tab);

        var content = document.createElement('div');
        content.classList.add('tab_content');
        content.id = this.count;
        var code_editor = document.createElement('div');
        code_editor.classList.add('editor');
        code_editor.setAttribute('contenteditable', 'true');
        code_editor.setAttribute('spellcheck', 'false');
        if (context !== undefined) {
          var lines = context.data.split(/\r\n|\n\r|\n|\r/);
          for (var temp of lines) {
            var empty = document.createElement('div');
            empty.id = 'editor_line';
            empty.className = 'editor_node_changed';

            if (temp === '') {
              temp = "<br/>";
              empty.innerHTML = "<br/>";
            } else {
              empty.innerText = temp;
            }

            code_editor.appendChild(empty);

          }
        } else {
          var empty = document.createElement('div');
          empty.innerHTML = "<br>";
          empty.id = 'editor_line'
          code_editor.appendChild(empty);
        }
        content.appendChild(code_editor);
        this.contents.appendChild(content);

        this.focus(this.count);
        context.tab_id = this.count;
        context.current_tab = this.count;
        this.tab_context.push(context);
        code_editor.focus();

        editor(code_editor, context);
      }

      rename() {
        var li = this.ul.querySelectorAll('li');
        for (var i = 0; i < li.length; i++) {
          const t = this.tab_context[i].file_name;
          if (li[i].firstChild.innerText != t) {
            li[i].firstChild.innerText = t;
          }
        }
      }
    }

    const tabs_code = new Tab('tabs_code');
  </script>

  <script>
    function FileContext() {
      var context = {
        //Common
        file_name: '', //파일 이름
        path: '',  //프로젝트 상 파일 경로
        language: '',  //언어
        data: '', //데이터
        edited: false,
        //editor 관련 속성
        current_line: 0,
        current_indent: 0,
        tab_id: 0,
        current_tab: 0,
        current_div: null,
        current_div_indent: 0,
      };
      return context;
    }
    class Tree {
      element;
      current_node;
      selection;
      list_context = [];
      rename_temp;
      drag_element;
      drag_target;
      is_drag = false;
      constructor(id) {
        this.element = document.getElementById(id);
        this.current_node = this.element;
        this.element.addEventListener('click', (event) => {
          if (event.target == this.element) {
            this.current_node = this.element;
            if (this.selection) {
              this.selection.classList.remove('selected');
              this.selection = this.element;
            }
          }
        });

        this.element.setAttribute('droppable', true);
        this.element.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        this.element.addEventListener('drop', (e) => {
          e.preventDefault();
          if (e.offsetY > 100) {
            var target = e.dataTransfer.getData('dragfile');
            if (target) {
              var target_el = this.element;
              var el = this.getElementByPath(target);
              if (el) {
                const check = target_el.querySelectorAll(':scope > li');
                for (const c of check) {
                  if (c.id == el.id) {
                    alert('File with the same name exists');
                  return false;
                  }
                }

                var con = this.getContextByPath(this.getPath(el));
                target_el.appendChild(el);

                var newpath = '\\' + el.id;
                con.path = newpath;

                el.firstChild.style.marginLeft = '';
                this.sort();
              }
            }
            else
            {
              target = e.dataTransfer.getData('dragfolder');
              if (target) {
                var target_el = this.element;
                var el = this.getElementByPath(target);
                if (el) {
                  //하위 폴더에 대한 이동 방지
                  const valid = el.querySelectorAll('ul');
                  for (const c of valid) {
                    if (c == target_el) {
                      return false;
                    }
                  }
                  //같은 이름 존재시 이동 방지
                  const check = target_el.querySelectorAll(':scope > ul');
                  for (const c of check) {
                    if (c.id == el.id && c != el) {
                      alert('Folder with the same name exists');
                      return false;
                    }
                  }

                  var new_path = '\\' + el.id;
                  var file_contexts = [];

                  var offset = parseFloat(el.firstChild.style.marginLeft);
                  if (!offset) { offset = 0; }

                  el.firstChild.style.marginLeft = '';
                  for (var f of el.querySelectorAll('li')) {
                    file_contexts.push(this.getContextByPath(this.getPath(f)));
                    var temp = parseFloat(f.firstChild.style.marginLeft)
                    if (!temp) { temp = 0; }
                    f.firstChild.style.marginLeft = (temp - offset) + 'px';
                  }
                  for(var f of el.querySelectorAll('ul'))
                  {
                    var temp = parseFloat(f.firstChild.style.marginLeft)
                    if (!temp) { temp = 0; }
                    f.firstChild.style.marginLeft = (temp - offset + 10) + 'px';
                  }

                  const regex = new RegExp('^' + target.replace(/\\/g, "\\\\"), 'gi');
                  for (var c of file_contexts) {
                    c.path = c.path.replace(regex, new_path);
                  }

                  target_el.appendChild(el);
                  this.sort();
                }

              }
            }
          }
        });
                

        document.getElementById('cm_newfile').addEventListener('click', (event) => {
          var input = prompt('Create File', 'empty.txt');
          if (input == null) {
            alert('File name is null.')
            return;
          }
          const li = tree_file.addFile(input);
          if (li) {
            if (this.selection) {
              this.selection.classList.remove('selected');
            }
            this.selection = li;
            this.selection.classList.add('selected');
            this.current_node = this.selection.parentElement;
          }
          this.sort();
        });
        document.getElementById('cm_newfolder').addEventListener('click', (event) => {
          var input = prompt('Create Folder', 'empty');
          if (input == null) {
            alert('Folder name is null.')
            return;
          }
          const ul = tree_file.addFolder(input);
          if (ul) {
            if (this.selection) {
              this.selection.classList.remove('selected');
            }
            this.selection = ul;
            this.selection.classList.add('selected');
            this.current_node = ul;
          }
          this.sort();
        });
        document.getElementById('cm_delete').addEventListener('click', (event) => {
          const t = this.getPath(this.selection);
          var valid = false;
          if (this.selection.tagName == 'UL') {
            if (confirm("Delete all files in a folder?") == true) {
              const regex = new RegExp('^' + t.replace(/\\/g, "\\\\"), 'gi');
              for (var i = 0; i < this.list_context.length;) {
                if (this.list_context[i].path.match(regex)) {
                  this.list_context.splice(i, 1);
                  continue;
                }
                i++
              }
              this.selection.remove();
              this.selection = this.element
            }
            return;
          }
          if (confirm("Delete \'" + this.selection.id + "\'?") == true) {
            for (var i = 0; i < this.list_context.length; i++) {
              if (this.list_context[i].path == t) {
                this.list_context.splice(i, 1);
                valid = true;
                this.selection.remove();
                this.selection = this.element
                break;
              }
            }
            if (!valid) {
              alert('Error');
            }
          }
        });
        document.getElementById('cm_rename').addEventListener('click', (event) => {
          this.selection.querySelector('.tree_text').setAttribute('contenteditable', 'true');
          this.selection.querySelector('.tree_text').focus();
          this.rename_temp = this.selection.querySelector('.tree_text').innerText;
        });
        document.addEventListener('keydown', (e) => {
          if (e.which == 113 && this.selection.classList.contains('tree_element')) {
            this.selection.querySelector('.tree_text').setAttribute('contenteditable', 'true');
            this.selection.querySelector('.tree_text').focus();
            this.rename_temp = this.selection.querySelector('.tree_text').innerText;
          }
        });
      }

      addFolder(name, parent = null) {
        if(parent)
        {
          this.current_node = parent;
        }
        const check = this.current_node.querySelectorAll('#' + this.current_node.id + ' > ul');
        for (const c of check) {
          if (c.id == name) {
            alert('same folder name');
            return c;
          }
        }

        const ul = document.createElement('ul');
        const node_wrapper = document.createElement('div');
        node_wrapper.classList.add('tree_bar');
        const folder_icon = document.createElement('div');
        folder_icon.innerText = '∨';//＞
        folder_icon.classList.add('tree_icon');
        node_wrapper.appendChild(folder_icon);
        const folder_text = document.createElement('div');
        folder_text.innerText = name;
        folder_text.classList.add('tree_text');
        folder_text.id = name;
        node_wrapper.appendChild(folder_text);

        node_wrapper.setAttribute('droppable', true);
        node_wrapper.addEventListener('dragover', (e) => {
          e.preventDefault();
        });
        node_wrapper.addEventListener('drop', (e) => {
          e.preventDefault();
          var target = e.dataTransfer.getData('dragfile');
          if (target) {
            var target_el = this.getNearestList(e.target)
            var el = this.getElementByPath(target);

            if (el) {
              const check = target_el.querySelectorAll(':scope > li');
              for (const c of check) {
                if (c.id == el.id) {
                  alert('File with the same name exists');
                return false;
                }
              }

              var con = this.getContextByPath(this.getPath(el));
              target_el.appendChild(el);

              var newpath = this.getPath(target_el) + '\\' + el.id;
              con.path = newpath;

              var offset = 0;
              if (target_el !== this.element) {
                offset = parseFloat(target_el.firstChild.style.marginLeft)
                if (!offset) { offset = 0; }
                el.firstChild.style.marginLeft = (offset + 10) + 'px';
              }
              this.sort();
            }
          }
          else
          {
            target = e.dataTransfer.getData('dragfolder');
            if (target) {
              var target_el = this.getNearestList(e.target);
              var el = this.getElementByPath(target);
              if (el && el !== target_el) {
                //하위 폴더에 대한 이동 방지
                const valid = el.querySelectorAll('ul');
                for(const c of valid)
                {
                  if(c == target_el)
                  {
                    return false;
                  }
                }
                //같은 이름 존재시 이동 방지
                const check = target_el.querySelectorAll(':scope > ul');
                for (const c of check) {
                  if (c.id == el.id && c != el) {
                    alert('Folder with the same name exists');
                    return false;
                  }
                }

                var new_path = this.getPath(target_el)+ '\\' + el.id;
                var file_contexts = [];

                var offset_t = parseFloat(target_el.firstChild.style.marginLeft);
                if (!offset_t) { offset_t = 0; }
                var offset_e = parseFloat(el.firstChild.style.marginLeft);
                if (!offset_e) { offset_e = 0; }
                var offset = offset_e - offset_t;
                el.firstChild.style.marginLeft = (offset_t + 10) + 'px';
                for(var f of el.querySelectorAll('li'))
                {
                  file_contexts.push(this.getContextByPath(this.getPath(f)));
                  var temp = parseFloat(f.firstChild.style.marginLeft)
                  if (!temp) { temp = 0; }
                  f.firstChild.style.marginLeft = (temp - offset + 10) + 'px';
                }
                for(var f of el.querySelectorAll('ul'))
                {
                  var temp = parseFloat(f.firstChild.style.marginLeft)
                  if (!temp) { temp = 0; }
                  f.firstChild.style.marginLeft = (temp - offset + 10) + 'px';
                }
                
                const regex = new RegExp('^' + target.replace(/\\/g, "\\\\"), 'gi');
                for(var c of file_contexts)
                {
                  c.path = c.path.replace(regex,new_path);
                }
                
                target_el.appendChild(el);
                this.sort();
              }
              
            }
          }

          return ul;
        });


        ul.setAttribute('draggable', true);
        ul.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('dragfolder', this.getPath(e.target));
        });


        ul.id = name;
        ul.classList.add('tree_element');

        ul.appendChild(node_wrapper);
        this.current_node.appendChild(ul);

        if (this.current_node !== this.element) {
          var offset = parseFloat(this.current_node.firstChild.style.marginLeft)
          if (!offset) { offset = 0; }
          node_wrapper.style.marginLeft = (offset + 10) + 'px';
        }
        this.current_node = ul;

        node_wrapper.addEventListener('click', (event) => {
          if (this.selection) {
            this.selection.classList.remove('selected');
          }
          if (event.target.id) {
            this.selection = event.target.parentElement.parentElement;
            this.selection.classList.add('selected');
            this.current_node = this.selection;
          }
        });
        folder_icon.addEventListener('click', (event) => {
          var c = event.target.innerText;
          const items = event.target.parentElement.parentElement.childNodes;
          if (c == '∨') {
            for (const i of items) {
              i.style.display = 'none';
            }
            items[0].style.display = '';
            event.target.innerText = '＞';
          }
          else if (c == '＞') {
            for (const i of items) {
              i.style.display = '';
            }
            event.target.innerText = '∨';
          }
        });
        folder_text.addEventListener('focusout', (e) => {
          this.rename(e.target);
        });
        folder_text.addEventListener('keydown', (e) => {
          if (e.which == '13') {
            e.preventDefault();
            this.rename(e.target);
          }
        });
        return ul;
      }

      addFile(file, ct = null) {
        const check = this.current_node.querySelectorAll(':scope > li');
        for (const c of check) {
          if (c.id == file) {
            alert('same file name');
            return false;
          }
        }

        const ul = ct ? this.element : this.current_node;
        const li = document.createElement('li');
        li.id = file;
        li.classList.add('tree_element');

        li.setAttribute('draggable', true);
        li.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('dragfile', this.getPath(e.target));
        });

        const node_wrapper = document.createElement('div');
        node_wrapper.classList.add('tree_bar');
        const file_icon = document.createElement('div');
        file_icon.innerText = '🗎';
        file_icon.classList.add('tree_icon');
        node_wrapper.appendChild(file_icon);
        const file_text = document.createElement('div');
        file_text.innerText = file;
        file_text.classList.add('tree_text');
        file_text.id = file;
        node_wrapper.appendChild(file_text);

        var offset = 0;
        if (ul !== this.element) {
          offset = parseFloat(ul.firstChild.style.marginLeft)
          if (!offset) { offset = 0; }
          node_wrapper.style.marginLeft = (offset + 10) + 'px';
        }

        li.appendChild(node_wrapper);
        ul.appendChild(li);

        if(!ct)
        {
          ct = FileContext();
          ct.file_name = file;
          ct.path = this.getPath(li);
        }
        this.list_context.push(ct);

        node_wrapper.addEventListener('click', (event) => {
          if (this.selection) {
            this.selection.classList.remove('selected');
          }
          if (event.target.id) {
            this.selection = event.target.parentElement.parentElement;
            this.selection.classList.add('selected');
            this.current_node = this.selection.parentElement;
          }
        });
        file_text.addEventListener('dblclick', (e) => {
          const c = this.getContextByPath(this.getPath(e.target.parentElement.parentElement));
          //console.log(c);
          tabs_code.addTab(c);
        });
        file_text.addEventListener('focusout', (e) => {
          this.rename(e.target);
        });
        file_text.addEventListener('keydown', (e) => {
          if (e.which == '13') {
            e.preventDefault();
            this.rename(e.target);
          }
        });
        return li;
      }

      sort(div = this.element) {
        var para = div.querySelectorAll(':scope > ul'); //폴더
        var paraArr = [].slice.call(para).sort(function (a, b) {
          return a.id > b.id ? 1 : -1;
        });
        paraArr.forEach(function (p) {
          div.appendChild(p);
        });
        
        var para2 = div.querySelectorAll(':scope > li'); //파일
        var paraArr2 = [].slice.call(para2).sort(function (a, b) {
          return a.id > b.id ? 1 : -1;
        });
        paraArr2.forEach(function (p) {
          div.appendChild(p);
        });
        
        for (var ul of para) {
          this.sort(ul);
        }
        if(div == this.element)
        {
          if(div.querySelector('.tree_empty'))
          {
            div.querySelector('.tree_empty').remove();
          }
          var empty = document.createElement('div');
          empty.classList.add('tree_empty');
          div.appendChild(empty); 
        }
      }

      rename(target) {
        target.setAttribute('contenteditable', 'false');
        if (target.innerText == '') {
          target.innerText = this.rename_temp;
          return;
        }

        var parent = this.getNearestList(target);
        if (parent.tagName == 'UL') //폴더
        {

          const path = this.getPath(parent);
          const regex = new RegExp('^' + path.replace(/\\/g, '\\\\') + '\\\\', 'i');
          var newpath = path.substring(0, path.lastIndexOf('\\') + 1) + target.innerText + '\\';
          for (var i = 0; i < this.list_context.length; i++) {
            if (this.list_context[i].path.match(regex)) {
              this.list_context[i].path = this.list_context[i].path.replace(regex, newpath);
            }
          }
        }
        else if (parent.tagName == 'LI') //파일
        {
          var con = this.getContextByPath(this.getPath(parent));
          con.file_name = target.innerText;
          const regex = new RegExp('\\\\' + this.rename_temp + '\$', 'gi');
          con.path = con.path.replace(regex, '\\' + target.innerText);
          tabs_code.rename();
        }

        target.id = target.innerText;
        parent.id = target.innerText;
      }
      getPath(target) {
        var path = '';
        var temp = target.parentElement;
        if (temp.id && temp !== this.element) {
          path += this.getPath(temp);
          path += '\\' + target.id;
        }
        else {
          path += '\\' + target.id;
        }
        return path;
      }

      getContextByPath(path) {
        for (var i = 0; i < this.list_context.length; i++) {
          if (this.list_context[i].path == path) {
            return (this.list_context[i]);
          }
        }
      }
      getElementByPath(path) {
        var p = path.split('\\');
        var e = this.element;
        for(var i = 1; i < p.length; i++)
        {
          e = e.querySelector('#' + e.id + ' > #' + p[i].replace(/\./g,'\\\.'));
        }
        return e;
      }
      getNearestList(target) {
        if (target.tagName == 'UL' || target.tagName == 'LI') {
          return target;
        }
        else if (target.tagName !== 'HTML') {
          return this.getNearestList(target.parentElement);
        }
        return null;
      }

     
    }
    const tree_file = new Tree('tree_file');

    tree_file.addFolder('te');
    tree_file.addFile('a');
    tree_file.addFile('b');
    tree_file.addFolder('ee');
    tree_file.addFile('v');
    tree_file.addFile('e');
    tree_file.addFolder('empty');
    tree_file.addFile('empty.txt');

    tree_file.sort(tree_file.element);
    tree_file.element.addEventListener("contextmenu", function (event) {
      if (document.getElementById("contextMenu").style.display == "block") {
        document.getElementById("contextMenu").style.display = "none"
      } else {
        var menu = document.getElementById("contextMenu")
        menu.style.display = 'block';
        menu.style.left = event.pageX + "px";
        menu.style.top = event.pageY + "px";
        if (tree_file.selection) {
          if (tree_file.selection.className == 'tree') {
            menu.querySelector('#cm_delete').style.display = 'none';
            menu.querySelector('#cm_rename').style.display = 'none';
          }
          else {
            menu.querySelector('#cm_delete').style.display = '';
            menu.querySelector('#cm_rename').style.display = '';
          }
        }
      }
      event.preventDefault();
    });

    document.addEventListener("click", function (event) {
      document.getElementById("contextMenu").style.display = "none"
    });

  </script>
  <script>
    const menu_assign = () => {
      var isclicked = false;
      var onmenu = false;
      const el = document.getElementById('menu_bar');
      el.addEventListener('mouseleave', (e) => {
        isclicked = false;
      });
      const menu_list = ['menu-file', 'menu-edit', 'menu-view'];
      for (var m of menu_list) {
        append(m) 
      }

      function append(m,parent = null) {
        const menu_element = document.getElementById(m);
        const menu_element_contents = document.getElementById(m + '-contents');
        if (menu_element && menu_element_contents) {
          menu_element.addEventListener('click', (e) => {
            isclicked = true;
            onmenu = true;
            const rect = menu_element.getBoundingClientRect();
            if (menu_element_contents.style.display == "block") {
              menu_element_contents.style.display = "none"
            } else {
              menu_element_contents.style.display = 'block';
              if(parent)
              {
                menu_element_contents.style.left = (rect.left + 200) + 'px';
                menu_element_contents.style.top = (rect.top - 2.5) + 'px';
              }
              else
              {
                menu_element_contents.style.left = rect.left + 'px';
                menu_element_contents.style.top = (rect.top + 20) + 'px';
              }
            }
          });
          menu_element.addEventListener('mouseenter', (e) => {
            onmenu = true;
            if(isclicked)
            {
              const rect = menu_element.getBoundingClientRect();
              menu_element_contents.style.display = 'block';
              if(parent)
              {
                menu_element_contents.style.left = (rect.left + 200) + 'px';
                menu_element_contents.style.top = (rect.top - 2.5) + 'px';
              }
              else
              {
                menu_element_contents.style.left = rect.left + 'px';
                menu_element_contents.style.top = (rect.top + 20) + 'px';
              }
            }
          });
          menu_element.addEventListener('mouseleave', (e) => {
            if(isclicked)
            {
              menu_element_contents.style.display = "none";
              onmenu = false;
            }
          });
          menu_element_contents.addEventListener('mouseenter', (e) => {
            if(parent)
            {
              parent.style.display = 'block';
            }
            menu_element_contents.style.display = 'block';
            onmenu = true;
          });
          menu_element_contents.addEventListener('mouseleave', (e) => {
            menu_element_contents.style.display = "none";
            onmenu = false;
          });

          for(var c of menu_element_contents.querySelectorAll('li'))
          {
            if(c.childNodes.length>1)
            {
              if(c.querySelector('.menu_extend'))
              {
                append(c.id, menu_element_contents);
              }
            }
            
          }
        }
      }

      document.addEventListener('click', (e) => {
        if(!onmenu)
        {
          for(var m of document.querySelectorAll('.menu_bar_box'))
          {
            m.style.display = "none";
          }
        }
      
      });
    };
    menu_assign();

    document.getElementById('open_file').onchange = function (event) {
      var file = event.target.files[0];
      if (!file) {
        return;
      }

      var reader = new FileReader();
      reader.onload = function (e) {
        fileData = e.target.result;
        const ct = FileContext();
        ct.file_name = file.name;
        ct.data = fileData;
        ct.path = '\\' + file.name;
        tabs_code.addTab(ct);
        const li = tree_file.addFile(file.name, ct);
          if (li) {
            if (tree_file.selection) {
              tree_file.selection.classList.remove('selected');
            }
            tree_file.selection = li;
            tree_file.selection.classList.add('selected');
            tree_file.current_node = tree_file.selection.parentElement;
          }
          tree_file.sort();
      };
      reader.readAsText(file, 'UTF-8');
    };
    document.getElementById('file-newfile').addEventListener('click', (e) => {
      var input = prompt('Create File', 'empty.txt');
          if (input == null) {
            alert('File name is null.')
            return;
          }
          const li = tree_file.addFile(input);
          if (li) {
            if (tree_file.selection) {
              tree_file.selection.classList.remove('selected');
            }
            tree_file.selection = li;
            tree_file.selection.classList.add('selected');
            tree_file.current_node = tree_file.selection.parentElement;
          }
          tree_file.sort();
    });

  </script>
  </body>
</html>