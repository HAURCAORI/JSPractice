<!DOCTYPE html>
<html>

<head>

  <title> test </title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/src/mystyle.css">
</head>

<body>
  <div id="header-wrapper">

  </div>
  <div id="workspace">
    <div class="panel-left-bar">
      <div class="bar-button" id='bt_open'>
        OPEN
      </div>
      <div class="bar-button" id='bt_save'>
        SAVE
      </div>
    </div>
    <div class="panel-left">

    </div>

    <div class="panel-center">
      <div class="tabs" id="tabs_code"> </div>
    </div>
    <div class="panel-bottom">

    </div>
  </div>
  <script type="text/javascript" src="js/intellisense.js"></script>
  <script>

    // Syntax highlight for JS
    const js = el => {
      for (const node of el.children) {
        const s = node.innerText
          .replace(/(\/\/.*)/g, '<em>$1</em>')
          .replace(
            /\b(new|if|else|do|while|switch|for|in|of|continue|break|return|typeof|function|var|const|let|\.length|\.\w+)(?=[^\w])/g,
            '<strong>$1</strong>',
          )
          .replace(/(".*?"|'.*?'|`.*?`)/g, '<strong><em>$1</em></strong>')
          .replace(/\b(\d+)/g, '<em><strong>$1</strong></em>');
        node.innerHTML = s.split('\n').join('<br/>');
      }
    };

    const context = {
      current_line: 0,
      current_indent: 0,
      current_div: null,
      current_div_indent: 0,
    };

    const editor = (el, c = context, highlight = js, tab = '    ') => {
      //caret 위치 관련
      const caret = () => {
        const range = window.getSelection().getRangeAt(0);
        const prefix = range.cloneRange();
        prefix.selectNodeContents(el);
        prefix.setEnd(range.endContainer, range.endOffset);
        return prefix.toString().length;
      };

      const setCaret = (pos, parent = el) => {
        for (const node of parent.childNodes) {
          if (node.nodeType == Node.TEXT_NODE) {
            if (node.length >= pos) {
              const range = document.createRange();
              const sel = window.getSelection();
              range.setStart(node, pos);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
              return -1;
            } else {
              pos = pos - node.length;
            }
          } else {
            pos = setCaret(pos, node);
            if (pos < 0) {
              return pos;
            }
          }
        }
        return pos;
      };

      highlight(el);

      //줄 추가
      const addLine = (parent = el) => {

        var div = document.createElement('div');
        div.id = 'editor_line';

        const r = window.getSelection().getRangeAt(0);
        const prefix = r.cloneRange();
        prefix.selectNodeContents(c.current_div);
        prefix.setStart(r.endContainer, r.endOffset);

        const str = prefix.toString();
        if (str != '') {
          div.innerHTML = prefix.toString();
        }
        else {
          div.innerHTML = '<br>';
        }
        if (str.length > 0) {
          prefix.deleteContents();
          prefix.insertNode(document.createElement('br'));
        }

        var temp = c.current_div.nextSibling;

        if (temp == null) {
          parent.appendChild(div);
        }
        else {
          parent.insertBefore(div, temp);
        }

        const range = document.createRange();
        range.selectNodeContents(div);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        selection.collapseToStart();
      };

      //키 입력
      var edit = false;
      var range_temp;
      el.addEventListener('keydown', e => {
        //console.log(e.which);
        getCurrentDiv();
        //editor 관련
        if (!show_intellisense) {
          if (e.which === 8) {//backspace
            if (el.childElementCount <= 1) {
              const pos = caret();
              if (pos <= 0) {
                e.preventDefault();
              }
            }
          }
          if (e.which === 9) {//tab
            insertTab();
            e.preventDefault();
          }
          if (e.shiftKey && e.which === 219) {//{
            c.current_indent++;
          }
          if (e.shiftKey && e.which === 221) {//}
            c.current_indent--;
            if (c.current_div_indent >= 1) {
              removeTab();
            }
          }
          if (e.which === 13) {//enter
            addLine();

            for (var i = 0; i < Math.floor(c.current_div_indent) + c.current_indent; i++) {
              insertTab();
            }
            e.preventDefault();
          }
          if (e.ctrlKey && e.which === 192) {
            intellisense.show();
            e.preventDefault();
          }
          if (e.which === 190)//.
          {
            edit = false;
          }
          if (edit == false && (event.keyCode >= 65 && event.keyCode <= 90)) {
            intellisense.show();
            edit = true;
            intellisense.temp += String.fromCharCode(e.which);
            intellisense.filter();
          }
          if (e.which === 32) { edit = false; };
          if (e.ctrlKey && e.which == 83) {
            save();
            e.preventDefault();
          }
        }
        else {
          if (e.which === 38 || e.which === 40) {
            e.preventDefault();
          }
          else if (e.which === 13) {//enter
            insertIntelli();
            intellisense.remove();
            e.preventDefault();
          }
          else if (e.keyCode >= 65 && e.keyCode <= 90) {
            intellisense.temp += String.fromCharCode(e.which);
            intellisense.filter();
          }
          else if (e.which === 20 || e.which === 16) {

          }
          else {
            intellisense.remove();
          }

          if (e.which === 8) {
            intellisense.temp = intellisense.temp.slice(0, -1);
          }
        }

      });
      el.addEventListener('keyup', e => {
        if (e.keyCode == 0x20) {//e.keyCode >= 0x30 || 
          const pos = caret();
          highlight(el);
          setCaret(pos);
        }
        if (show_intellisense) {
          range_temp = window.getSelection().getRangeAt(0);
        }
      });


      //함수 모음
      function getLine() {
        var nodes = Array.prototype.slice.call(el.children);
        //var liRef = window.getSelection().getRangeAt(0).commonAncestorContainer.parentNode;
        var num = nodes.indexOf(c.current_div);
        if (num !== -1) {
          c.current_line = num + 1;
        }
      }
      function getCurrentDiv() {
        const range = window.getSelection().getRangeAt(0);
        var div = range.commonAncestorContainer;
        while (div.id != 'editor_line') {
          div = div.parentNode;
        }
        c.current_div = div;
        //탭 개수 구하기
        const prefix = range.cloneRange();
        prefix.selectNodeContents(div);
        prefix.setEnd(range.endContainer, range.endOffset);
        const str = prefix.toString();
        var count = 0;
        for (var i = 0; i < str.length; i++) {
          if (str.charAt(i) != ' ') {
            break;
          }
          count++;
        }
        c.current_indent = 0;
        c.current_indent += (str.match(/\{/g) || []).length;
        c.current_indent -= (str.match(/\}/g) || []).length;
        c.current_div_indent = count / 4;
      }
      function insertTab() {
        const pos = caret() + tab.length;
        const range = window.getSelection().getRangeAt(0);
        range.deleteContents();
        range.insertNode(document.createTextNode(tab));
        highlight(el);
        setCaret(pos);
      }
      function removeTab() {
        const range = window.getSelection().getRangeAt(0);
        const prefix = range.cloneRange();
        prefix.selectNodeContents(c.current_div);
        prefix.setEnd(range.endContainer, 4);
        prefix.deleteContents();
      }
      function insertIntelli() {
        var str = intellisense.liSelected.innerHTML;
        str = str.slice(intellisense.temp.length);

        const range = range_temp;
        const prefix = range.cloneRange();
        prefix.selectNodeContents(el);
        prefix.setEnd(range.endContainer, range.endOffset);

        var pos = prefix.toString().length + str.length;
        if (str.slice(-1) == ')') { pos--; }
        range.deleteContents();
        range.insertNode(document.createTextNode(str));
        highlight(el);
        setCaret(pos);
      }


      function save() {
        var text = '';
        for (const node of el.children) {
          text += node.innerHTML.replace(/\<\/?br\>/g, '').replace(/\<\/?strong\>/g, '').replace(/\<\/?em\>/g, '');
          text += '\n';
        }
        var textFile = null;
        var data = new Blob([text], { type: 'text/plain' });

        if (textFile !== null) {
          window.URL.revokeObjectURL(textFile);
        }
        
        textFile = window.URL.createObjectURL(data);
        var link = document.createElement("a");
        link.href = textFile;
        link.download = "a.txt";
        link.click();
      }
      const bt_save = document.getElementById('bt_save');
      bt_save.addEventListener('click', (event) => {
        save();
      });

      //변경 이벤트
      MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
      var observer = new MutationObserver(function (mutations, observer) {
        //console.log(mutations, observer);
        getLine();
      });

      // define what element should be observed by the observer
      // and what types of mutations trigger the callback
      observer.observe(document, {
        subtree: true, characterData: false, childList: true, attributes: true
      });


      //intellisense 구현
      show_intellisense = false;
      const intellisense = {
        liSelected: null,
        temp: '',
        list: [],
        view: null,
        listbox: null,
        show: function () {
          this.temp = '';
          this.list = [];
          const range = window.getSelection().getRangeAt(0);
          range.deleteContents();
          const span = document.createElement('span');
          range.insertNode(span);
          const temp = span.getBoundingClientRect();
          var x = temp.left;
          var y = temp.bottom;
          span.remove();

          const view = document.createElement('div');
          view.id = 'intellisense';
          view.style.left = x + 'px';
          view.style.top = y + 'px';
          this.view = view;

          const listbox = document.createElement('div');
          listbox.id = "listbox";
          this.listbox = listbox;

          this.import_list();

          this.list_update();

          view.appendChild(listbox);
          document.body.appendChild(view);
          show_intellisense = true;
        },
        import_list: function () {
          for (var i = 0; i < _javascript.keywords.length; i++) {
            this.list.push(_javascript.keywords[i]);
          }

          for (var i = 0; i < _javascript.object.length; i++) {
            const methods = _javascript[_javascript.object[i]].methods;
            for (var j = 0; j < methods.length; j++) {
              this.list.push(methods[j]);
            }
            const properties = _javascript[_javascript.object[i]].properties;
            for (var j = 0; j < properties.length; j++) {
              this.list.push(properties[j]);
            }
            const child = _javascript[_javascript.object[i]].child;
            if (child) {
              for (var j = 0; j < child.length; j++) {
                this.list.push(child[j]);
              }
            }
          }

        },
        filter: function () {
          const regex = new RegExp('^' + this.temp, 'gi');
          const temp_list = []
          for (var i = 0; i < this.list.length; i++) {
            if (this.list[i].match(regex)) {
              temp_list.push(this.list[i]);
            }
          }
          this.list = temp_list;
          this.list_update();
        },
        list_update: function () {
          while (this.listbox.hasChildNodes()) { this.listbox.removeChild(this.listbox.firstChild); }

          const ul = document.createElement('ul');
          ul.classList.add('list');

          const li_list = [];

          if (this.list.length > 0) {
            var index = 0;
            //목록 리스트 생성
            for (var i = 0; i < this.list.length; i++) {
              const li = document.createElement('li');
              li.innerHTML = this.list[i];
              li.id = i;
              ul.appendChild(li);
              li_list.push(li);
              li.addEventListener('click', e => {
                this.liSelected.classList.remove('list_selected');
                index = li.id;
                this.liSelected = li_list[index]
                this.liSelected.classList.add('list_selected');
                insertIntelli();
                intellisense.remove();
              });
            }

            //방향키 사용
            li_list[0].classList.add('list_selected')
            this.liSelected = li_list[0];
            el.addEventListener('keydown', e => {
              if (show_intellisense) {
                if (e.which === 40)//down
                {
                  this.liSelected.classList.remove('list_selected');
                  index++;
                  if (index < li_list.length) {
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  } else {
                    index = li_list.length - 1;
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  }
                  this.view.scrollTop = (this.liSelected.offsetTop - 50);
                  e.preventDefault();
                }
                else if (e.which === 38)//up
                {
                  this.liSelected.classList.remove('list_selected');
                  index--;
                  if (index > 0) {
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  } else {
                    index = 0;
                    this.liSelected = li_list[index]
                    this.liSelected.classList.add('list_selected');
                  }
                  this.view.scrollTop = (this.liSelected.offsetTop - 50);
                  e.preventDefault();
                }
              }
            });
          }
          else {
            this.remove();
          }
          this.listbox.appendChild(ul);
        },
        remove: function () {
          if (document.getElementById('intellisense')) {
            document.getElementById('intellisense').remove();
          }
          show_intellisense = false;
        }
      };
    };
  </script>
  <script>

    class Tab {
      element;
      ul;
      contents;
      tab_context = [];
      previous = 0;
      count = 0;
      constructor(id) {
        this.element = document.getElementById(id);
        var ul = document.createElement('ul');
        var div = document.createElement('div');
        div.classList.add('tab-wrapper');
        this.element.appendChild(ul);
        this.element.appendChild(div);

        this.ul = this.element.querySelector('ul');
        this.contents = this.element.querySelector('div');
      }
      focus(index) {
        if (this.count > 0) {
          var li = this.ul.querySelectorAll('li');
          var con = this.contents.querySelectorAll("div[class='tab_content'");
          if (this.previous > 0 && this.previous <= this.count) {
            li[this.previous - 1].classList.remove('tab_current');
            con[this.previous - 1].style.display = 'none';
          }

          li[index - 1].classList.add('tab_current');
          con[index - 1].style.display = 'block';
          this.previous = index;
        }
      }

      update() {
        var li = this.ul.querySelectorAll('li');
        var con = this.contents.querySelectorAll("div[class='tab_content'");
        for (var i = 0; i < li.length; i++) {
          li[i].id = i + 1;
        }
        for (var i = 0; i < con.length; i++) {
          con[i].id = i + 1;
        }
      }
      closeTab(index) {
        this.count--;
        var li = this.ul.querySelectorAll('li');
        var con = this.contents.querySelectorAll("div[class='tab_content'");
        if (index <= this.previous) {
          this.previous--;
        }
        if (this.previous < 1)
          this.previous = 1;
        li[index - 1].remove();
        con[index - 1].remove();
        this.update();
        this.focus(this.previous);
      }

      addTab(name) {
        this.count++;
        var tab = document.createElement('li')
        tab.classList.add('tab');
        tab.id = this.count;
        tab.innerHTML = name;
        tab.addEventListener('click', (event) => {
          if (event.target.id != "") {
            this.focus(event.target.id);
          }
        });
        var tab_close = document.createElement('div');
        tab_close.classList.add('tab_close');
        tab_close.innerHTML = '×';
        tab_close.addEventListener('click', (event) => {
          this.closeTab(event.target.parentElement.id);
        });
        tab.appendChild(tab_close);
        this.ul.appendChild(tab);

        var content = document.createElement('div');
        content.classList.add('tab_content');
        content.id = this.count;
        var code_editor = document.createElement('div');
        code_editor.classList.add('editor');
        code_editor.setAttribute('contenteditable', 'true');
        code_editor.setAttribute('spellcheck', 'false');
        var empty = document.createElement('div');
        empty.innerHTML = "<br>";
        empty.id = 'editor_line'
        code_editor.appendChild(empty);
        content.appendChild(code_editor);
        this.contents.appendChild(content);

        const ct = {
          current_line: 0,
          current_indent: 0,
          current_div: null,
          current_div_indent: 0,
        };
        this.focus(this.count);
        this.tab_context.push(ct);
        code_editor.focus();
        editor(code_editor,ct);
      }
    }

    const tabs_code = new Tab('tabs_code');
    tabs_code.addTab('first');
    tabs_code.addTab('second');
  </script>
</body>

</html>